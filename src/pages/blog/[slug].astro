---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { Icon } from 'astro-icon/components';
import { getCollection, render } from 'astro:content';
import { business } from '../../data/business';
import { blogUrl, contactUrl } from '../../lib/urls';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const title = `${post.data.title} | Great Yarmouth Plumbers`;
const description = post.data.description;

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Blog', href: '/blog/' },
  { label: post.data.title },
];

const publishDate = new Date(post.data.publishDate);
const formattedDate = publishDate.toLocaleDateString('en-GB', {
  day: 'numeric',
  month: 'long',
  year: 'numeric',
});
---

<BaseLayout {title} {description}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'BlogPosting',
      headline: post.data.title,
      description: post.data.description,
      datePublished: post.data.publishDate,
      author: {
        '@type': 'Organization',
        name: post.data.author || business.name,
        url: business.website,
      },
      publisher: {
        '@type': 'Organization',
        name: business.name,
        url: business.website,
      },
      mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': `${business.website}${blogUrl(post.id)}`,
      },
      url: `${business.website}${blogUrl(post.id)}`,
    })} />
  </Fragment>

  <Breadcrumbs items={breadcrumbs} />

  <article class="bg-white py-16">
    <div class="mx-auto max-w-3xl px-4 sm:px-6 lg:px-8">
      <!-- Article Header -->
      <header class="mb-10">
        <div class="mb-4 flex flex-wrap items-center gap-3">
          <span class="rounded-full bg-brand-50 px-3 py-1 text-xs font-semibold text-brand-700">
            {post.data.category}
          </span>
          {post.data.readingTime && (
            <span class="text-sm text-gray-400">{post.data.readingTime}</span>
          )}
        </div>
        <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 sm:text-4xl">
          {post.data.title}
        </h1>
        <div class="mt-4 flex items-center gap-4 text-sm text-gray-500">
          <div class="flex items-center gap-2">
            <Icon name="lucide:calendar" class="h-4 w-4" />
            <time datetime={post.data.publishDate}>{formattedDate}</time>
          </div>
          <div class="flex items-center gap-2">
            <Icon name="lucide:user" class="h-4 w-4" />
            <span>{post.data.author || business.name}</span>
          </div>
        </div>
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="mt-4 flex flex-wrap gap-2">
            {post.data.tags.map((tag: string) => (
              <span class="rounded-md bg-gray-100 px-2 py-1 text-xs text-gray-600">
                {tag}
              </span>
            ))}
          </div>
        )}
      </header>

      <!-- Article Content -->
      <div class="prose prose-lg prose-gray max-w-none prose-headings:font-extrabold prose-headings:text-gray-900 prose-a:text-brand-600 hover:prose-a:text-brand-700 prose-img:rounded-xl">
        <Content />
      </div>

      <!-- Author / CTA -->
      <footer class="mt-12 rounded-xl bg-gray-50 p-8">
        <div class="flex flex-col items-center gap-4 text-center sm:flex-row sm:text-left">
          <div class="flex h-16 w-16 shrink-0 items-center justify-center rounded-full bg-brand-100 text-brand-700">
            <Icon name="lucide:droplets" class="h-8 w-8" />
          </div>
          <div class="flex-1">
            <p class="font-bold text-gray-900">{business.name}</p>
            <p class="mt-1 text-sm text-gray-600">
              Need help with a plumbing problem? Our team is ready to assist. Call us on {business.phone} for a free quote.
            </p>
          </div>
          <a
            href={business.phoneHref}
            class="inline-flex items-center gap-2 rounded-lg bg-brand-600 px-6 py-3 text-sm font-bold text-white transition hover:bg-brand-700"
          >
            <Icon name="lucide:phone" class="h-4 w-4" />
            Call Now
          </a>
        </div>
      </footer>
    </div>
  </article>
</BaseLayout>
