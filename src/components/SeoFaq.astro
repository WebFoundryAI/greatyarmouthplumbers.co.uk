---
import { Icon } from 'astro-icon/components';

export interface FaqItem {
  question: string;
  answer: string;
}

export interface Props {
  faqs: FaqItem[];
  schema?: Record<string, unknown>;
}

const { faqs, schema } = Astro.props;

/* Build FAQPage schema from the supplied faqs if no custom schema provided */
const faqSchema = schema || {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqs.map((faq) => ({
    '@type': 'Question',
    name: faq.question,
    acceptedAnswer: {
      '@type': 'Answer',
      text: faq.answer,
    },
  })),
};
---

{faqs.length > 0 && (
  <section class="py-10">
    <h2 class="font-display text-2xl font-bold text-brand-900 mb-6">
      Frequently Asked Questions
    </h2>

    <div class="space-y-3" id="faq-accordion">
      {faqs.map((faq, index) => (
        <div class="border border-stone-200 rounded-lg overflow-hidden">
          <button
            type="button"
            class="faq-toggle flex w-full items-center justify-between px-5 py-4 text-left font-medium text-stone-800 hover:bg-stone-50 transition-colors"
            aria-expanded="false"
            aria-controls={`faq-panel-${index}`}
            id={`faq-btn-${index}`}
          >
            <span class="pr-4">{faq.question}</span>
            <Icon
              name="lucide:chevron-down"
              class="h-5 w-5 shrink-0 text-brand-600 transition-transform duration-200 faq-chevron"
            />
          </button>
          <div
            id={`faq-panel-${index}`}
            role="region"
            aria-labelledby={`faq-btn-${index}`}
            class="hidden px-5 pb-4 text-stone-600 leading-relaxed"
          >
            <p>{faq.answer}</p>
          </div>
        </div>
      ))}
    </div>

    <script
      type="application/ld+json"
      set:html={JSON.stringify(faqSchema)}
    />
  </section>
)}

<script>
  document.querySelectorAll('.faq-toggle').forEach((btn) => {
    btn.addEventListener('click', () => {
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      const panelId = btn.getAttribute('aria-controls');
      if (!panelId) return;
      const panel = document.getElementById(panelId);
      if (!panel) return;

      /* Close all others first */
      document.querySelectorAll('.faq-toggle').forEach((other) => {
        if (other !== btn) {
          other.setAttribute('aria-expanded', 'false');
          const otherId = other.getAttribute('aria-controls');
          if (otherId) {
            const otherPanel = document.getElementById(otherId);
            if (otherPanel) otherPanel.classList.add('hidden');
          }
          const otherChevron = other.querySelector('.faq-chevron') as HTMLElement | null;
          if (otherChevron) otherChevron.style.transform = '';
        }
      });

      /* Toggle current */
      btn.setAttribute('aria-expanded', String(!expanded));
      panel.classList.toggle('hidden');
      const chevron = btn.querySelector('.faq-chevron') as HTMLElement | null;
      if (chevron) {
        chevron.style.transform = expanded ? '' : 'rotate(180deg)';
      }
    });
  });
</script>
